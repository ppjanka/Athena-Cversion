#!/bin/bash
# Script for running core regression tests
#
# Can run script directly, or use following (in athena root directory):
#  > make rtest
#
# Core tests consist of checking error in linear waves for each combination of
#   CTU/VL integrator 
#   hydro/mhd
#   isothermal/adiabatic EOS
#   1D/2D/3D
#
# The CTU tests use order=3 reconstruction, and the VL tests use order=3p.
# All tests use the Roe solver.
#
# Note that the problem generator used to run linear waves (linear_wave.c) will
# print warning message to stdout if error exceeds estimate; this script checks
# to see if that warning message was produced.

PROB="linear_wave"
RUN_OPTS="time/tlim=1.2 problem/vflow=0.3 job/maxout=0"

CNT=0
TOTAL=24

rm -f LinWave-errors.0.dat
rm -f LinWave-errors.2.dat

#-------------------- loop over integrators -----------------------
for INT in ctu vl
do

  if [ "$INT" == "vl" ]; then
    ORD="3p"
  else
    ORD="3"
  fi

#-------------------- loop over gas type -----------------------
  for GAS in hydro mhd
  do

#-------------------- loop over EOS ------------------------------
    for EOS in isothermal adiabatic
    do

      cd ../..
      make clean > clean.log
      let CNT=CNT+1

# configure code

      if ! configure --with-integrator=$INT --with-gas=$GAS --with-eos=$EOS --with-problem=$PROB --with-order=$ORD --with-flux=roe &> config.log
      then
        echo "Configure for test $CNT failed"
        exit
      fi

# compile code

      if ! make all &> make.log
      then
        echo "Compile for test $CNT failed"
        exit
      fi
      rm -rf clean.log config.log make.log

      cd tst/regression
      mv ../../bin/athena .

# run 1D test
      if [ "$INT" == "vl" ]; then
        CFL="time/cour_no=0.4"
      else
        CFL=""
      fi

      if ! athena -i ../1D-$GAS/athinput.linear_wave1d $RUN_OPTS $CFL &> athena.log
      then
        echo "Athena crashed on test $CNT"
        exit
      fi

      if grep -q "WARNING" athena.log
      then
        echo "Regression test $CNT failed"
        exit
      fi
  
      echo "Passed $CNT of $TOTAL: 1D $EOS $GAS linear wave using $INT " 

# run 2D test
      let CNT=CNT+1
      if [ "$INT" == "vl" ]; then
        CFL="time/cour_no=0.4"
      else
        CFL=""
      fi

      if ! athena -i ../2D-$GAS/athinput.linear_wave2d $RUN_OPTS $CFL &> athena.log
      then
        echo "Athena crashed on test $CNT"
        exit
      fi
      if grep -q "WARNING" athena.log
      then
        echo "Regression test $CNT failed"
        exit
      fi
  
      echo "Passed $CNT of $TOTAL: 2D $EOS $GAS linear wave using $INT " 

# run 3D test
      let CNT=CNT+1
      if ! athena -i ../3D-$GAS/athinput.linear_wave3d $RUN_OPTS &> athena.log
      then
        echo "Athena crashed on test $CNT"
        exit
      fi
      if grep -q "WARNING" athena.log
      then
        echo "Regression test $CNT failed"
        exit
      fi
  
      rm -f athena.log
      rm -f athena

      echo "Passed $CNT of $TOTAL: 3D $EOS $GAS linear wave using $INT " 

    done
  done
done
